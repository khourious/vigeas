#!/bin/bash

# ill-hyb-direct-assembly <fastq_folder> <sample_sheet> <ref_seq_list> <se>

INPUT=$1
SAMPLE_SHEET=$2
REF_SEQ_LIST=$3
DEPTH=10
PIDENT=90
SE=0 # 0 = paired-end; 1 = single-end

if [[ -n "$MAMBA_EXE" ]]; then
    if [[ "$MAMBA_EXE" == *"micromamba"* ]]; then
        eval "$($MAMBA_EXE shell hook -s posix)"
        ENV_MANAGER=micromamba
    else
        ENV_MANAGER=mamba
    fi
elif [[ -n "$CONDA_EXE" ]]; then
    ENV_MANAGER=conda
fi

LIBRARY_NAME="$(basename $SAMPLE_SHEET | awk -F. '{print $1}')"
ASSEMBLY_DIR="$HOME/vigeas/${LIBRARY_NAME}_ASSEMBLY"

[[ ! -d "$ASSEMBLY_DIR" ]] && mkdir "$ASSEMBLY_DIR" && chmod 700 -R "$ASSEMBLY_DIR"
echo "" && echo "Output path: $ASSEMBLY_DIR"
echo "" && echo "Log Analysis: $ASSEMBLY_DIR/$LIBRARY_NAME.log.$(uname -n).$(date +'%Y-%m-%d').txt"
echo "" && echo "To display the log output in fulscreen: watch tail -n 20 $ASSEMBLY_DIR/$LIBRARY_NAME.log.$(uname -n).$(date +'%Y-%m-%d').txt" && echo ""

if grep -q "Experiment Name" "$SAMPLE_SHEET"; then
    cat "$SAMPLE_SHEET" | tr -dc '[:print:]\n' | sed -n '/^Sample_ID/,$p' | sed '1d' | awk -F, > "$ASSEMBLY_DIR/.samplesheet"
    SAMPLE_SHEET="$ASSEMBLY_DIR/.samplesheet"
fi

bg() {
    start=$(date +%s.%N)
    if [[ -z "$THREADS" ]]; then
        if ((NPROC > 2)); then
            THREADS=$((NPROC - 2))
        else
            THREADS=2
        fi
    fi
    "$ENV_MANAGER" list -n vigeas-ill 'bbmap|blast|bwa-mem2|entrez-direct|exonerate|fastp|ivar|mafft|samtools|seqkit|seqtk|spades' && echo ""
    echo "" && "$ENV_MANAGER" list -n vigeas-stats 'exonerate|ghostscript|r-base|r-cowplot|r-dplyr|r-ggplot2|r-patchwork|r-plyr|r-readr|r-svglite|samtools|seqkit|seqtk' && echo ""
    while IFS= read -r ID; do
        R1=$(find "$INPUT" -type f -regex ".*/${ID}.*\(_R1\|_1\|\.R1\).*\.fastq\.gz" -print -quit)
        R2=$(find "$INPUT" -type f -regex ".*/${ID}.*\(_R2\|_2\|\.R2\).*\.fastq\.gz" -print -quit)
        if [[ -n "$R1" ]]; then
            cp -v "$R1" "$ASSEMBLY_DIR/${ID}.R1.fastq.gz"
            [[ -n "$R2" ]] && cp -v "$R2" "$ASSEMBLY_DIR/${ID}.R2.fastq.gz"
            continue
        fi
    done < <(awk -F, '{print $1}' "$SAMPLE_SHEET")

    [[ ! -f "$ASSEMBLY_DIR/.summary" ]] && {
        echo -e "sample_id\tref_seq\ttarget\tsegment\tflu_vaccine\tnum_total_reads\tnum_mapp_reads\tavg_depth\tdepth_10x\tdepth_100x\tdepth_1000x\tref_cov\tncount\tncount_perc" > "$ASSEMBLY_DIR/.summary"
    }

    while IFS= read -r DESCRIPTION || [ -n "$DESCRIPTION" ]; do
        SAMPLE_ID=$(echo "$DESCRIPTION" | awk -F, '{print $1}')
        PANEL=$(echo "$DESCRIPTION" | awk -F, '{print $2}')
        echo "" && echo "$SAMPLE_ID" && echo "$PANEL"
        mkdir "$ASSEMBLY_DIR"/"$SAMPLE_ID"
        "$ENV_MANAGER" activate vigeas-ill
        if [[ "$SE" == 1 ]]; then
            fastp --thread "$THREADS" -f 0 -t 0 -F 0 -T 0 --cut_front --cut_tail --qualified_quality_phred 20 -l 75 -i "$ASSEMBLY_DIR/$SAMPLE_ID.R1.fastq.gz" -o "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" -h "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.html" -j "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.json"
            spades.py -t "$THREADS" --metaviral -s "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" -o "$ASSEMBLY_DIR/$SAMPLE_ID/denovo"
        else
            fastp --thread "$THREADS" -f 0 -t 0 -F 0 -T 0 --cut_front --cut_tail --qualified_quality_phred 20 -l 75 -i "$ASSEMBLY_DIR/$SAMPLE_ID.R1.fastq.gz" -I "$ASSEMBLY_DIR/$SAMPLE_ID.R2.fastq.gz" -o "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" -O "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R2.fastq.gz" -h "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.html" -j "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.json"
            spades.py -t "$THREADS" --metaviral -1 "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" -2 "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R2.fastq.gz" -o "$ASSEMBLY_DIR/$SAMPLE_ID/denovo"
        fi
        if [ -f "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/transcripts.fasta" ]; then
            blastn -num_threads "$THREADS" -word_size 21 -query "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/transcripts.fasta" -db "$HOME/vigeas/blastdb/$PANEL" -out "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.blastn.txt" -outfmt "6 qseqid sseqid pident length"
            seqtk seq -F '!' "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/transcripts.fasta" > "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/transcripts.fastq"
            gzip "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/transcripts.fastq"
            cat "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/transcripts.fastq" > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.concat.R1.fastq.gz"
        elif [ -f "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/before_rr.fasta" ]; then
            blastn -num_threads "$THREADS" -word_size 21 -query "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/before_rr.fasta" -db "$HOME/vigeas/blastdb/$PANEL" -out "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.blastn.txt" -outfmt "6 qseqid sseqid pident length"
            seqtk seq -F '!' "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/before_rr.fasta" > "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/before_rr.fastq"
            gzip "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/before_rr.fastq"
            cat "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" "$ASSEMBLY_DIR/$SAMPLE_ID/denovo/before_rr.fastq.gz" > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.concat.R1.fastq.gz"
        else
            seqkit fq2fa "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R1.fastq.gz" | blastn -db "$HOME/vigeas/blastdb/$PANEL" -out "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.blastn.txt" -outfmt "6 qseqid sseqid pident length"
        fi
        "$ENV_MANAGER" deactivate
        while IFS= read -r REFSEQ; do
            echo ""
            {
                printf "%s\t" "${SAMPLE_ID}"
                grep "^$REFSEQ" "$HOME/vigeas/blastdb/$PANEL.tsv" | awk -F"\t" '{if ($3 == "" || $3 == " " || gsub(/\t/, "", $3) == 0) {printf "%s\t%s\t%s\t%s\t", $1, $2, $3, $4} else {printf "%s\t", $0}}'
            } >> "$ASSEMBLY_DIR/.summary"
            "$ENV_MANAGER" activate vigeas-ill
            bwa-mem2 index -p "$HOME/vigeas/refseq/$REFSEQ" "$HOME/vigeas/refseq/$REFSEQ.fasta"
            if [[ "$SE" == 1 ]]; then
                bwa-mem2 mem -t "$THREADS" "$HOME/vigeas/refseq/$REFSEQ" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.concat.R1.fastq.gz" | samtools sort - > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.concat.sorted.bam"
            else
                bwa-mem2 mem -t "$THREADS" "$HOME/vigeas/refseq/$REFSEQ" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.concat.R1.fastq.gz" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R2.fastq.gz" | samtools sort - > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.concat.sorted.bam"
            fi
            samtools index "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.concat.sorted.bam"
            samtools consensus -m simple -a -aa -A -d 1 -@ "$THREADS" --show-del no --show-ins yes -f fasta "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.concat.sorted.bam" -o "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.concat.fasta"
            bwa-mem2 index -p "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.concat" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.concat.fasta"
            if [[ "$SE" == 1 ]]; then
                bwa-mem2 mem -t "$THREADS" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.concat" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.concat.R1.fastq.gz" | samtools sort - > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam"
            else
                bwa-mem2 mem -t "$THREADS" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.concat" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.concat.R1.fastq.gz" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.trimmed.R2.fastq.gz" | samtools sort - > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam"
            fi
            samtools index "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam"
            {
                seqkit stats "$ASSEMBLY_DIR/$SAMPLE_ID.R1.fastq.gz" | awk 'NR==2{gsub(/,/, "", $4); printf "%s\t", $4}'
                samtools view -F 4 -c "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam" | awk '{printf "%s\t", $1}'
            } >> "$ASSEMBLY_DIR/.summary"
            samtools depth -a "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam" > "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.depth.tsv"
            samtools mpileup -a -A -d 0 --reference "$HOME/vigeas/refseq/$REFSEQ.fasta" -B "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam" | ivar variants -q 20 -t 0.03 -m "$DEPTH" -p "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ" -r "$HOME/vigeas/refseq/$REFSEQ.fasta"
            samtools mpileup -a -A -d 0 --reference "$HOME/vigeas/refseq/$REFSEQ.fasta" -B "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam" | ivar consensus -t 0 -m "$DEPTH" -p "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.depth${DEPTH}"
            sed -i -e "s/>.*/>${SAMPLE_ID}/g" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.depth${DEPTH}.fa"
            "$ENV_MANAGER" deactivate
            "$ENV_MANAGER" activate vigeas-stats
            {
                AVG_DEPTH=$(samtools depth "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam" | awk '{sum+=$3} END {print (NR>0) ? sum/NR : 0}')
                printf "%.2f\t" "$AVG_DEPTH"
                REF_LEN=$(fastalength "$HOME/vigeas/refseq/$REFSEQ.fasta" | awk '{print $1}')
                for depth in 10 100 1000; do
                    samtools depth "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.trimmed.sorted.bam" | awk -v cutoff="$depth" -v reflen="$REF_LEN" '$3 > cutoff {covered++} END {printf "%.2f\t", (reflen>0) ? covered/reflen*100 : 0}'
                done
                if [[ ! -s "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.depth${DEPTH}.fa" ]] || ! grep -v "^>" "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.depth${DEPTH}.fa" | grep -q "[ACGTacgtNn]"; then
                    printf "0.00\t0\t100.00\n"
                else
                    N_COUNT=$(seqtk comp "$ASSEMBLY_DIR/$SAMPLE_ID/$SAMPLE_ID.$REFSEQ.depth${DEPTH}.fa" | awk '{print $9}')
                    REF_COV=$(echo "$N_COUNT $REF_LEN" | awk '{printf "%.2f", ($2 - $1) * 100 / $2}')
                    N_PERC=$(echo "$N_COUNT $REF_LEN" | awk '{printf "%.2f", $1 * 100 / $2}')
                    printf "%s\t" "$REF_COV"
                    printf "%d\t" "$N_COUNT"
                    printf "%s\n" "$N_PERC"
                fi
            } >> "$ASSEMBLY_DIR/.summary"
        done < "$REF_SEQ_LIST"
    done < "$SAMPLE_SHEET"
    "$ENV_MANAGER" deactivate
    sed '/^[[:space:]]*$/d' "$ASSEMBLY_DIR/.summary" > "$ASSEMBLY_DIR/$LIBRARY_NAME.summary.$(uname -n).$(date +'%Y-%m-%d').txt"
    rm -rf "$ASSEMBLY_DIR/.samplesheet" "$ASSEMBLY_DIR/.summary" "$ASSEMBLY_DIR"/*.fastq.gz
    end=$(date +%s.%N)
    runtime=$(python3 -c "print(${end} - ${start})")
    echo "" && echo "Done. The runtime was $runtime seconds." && echo ""
}

bg &>>"$ASSEMBLY_DIR/$LIBRARY_NAME.log.$(uname -n).$(date +'%Y-%m-%d').txt" &
exit 0
