#!/bin/bash

chmod 700 -R $HOME/vigeas/scripts

if [[ -z $(cat $HOME/.$(basename $SHELL)rc | grep vigeas) ]]; then
    echo 'export PATH=$HOME/vigeas/scripts:/usr/local/share/rsi/idl/bin:$PATH' >> $HOME/.$(basename $SHELL)rc
fi

if [[ -z $(which conda) ]]; then
    cd
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -bfp miniconda3
    rm Miniconda3-latest-Linux-x86_64.sh
    if [[ -z $(cat $HOME/.$(basename $SHELL)rc | grep vigeas) ]]; then
        echo 'export PATH=$HOME/miniconda3/bin:/usr/local/share/rsi/idl/bin:$PATH' >> $HOME/.$(basename $SHELL)rc
    fi
    source $HOME/.$(basename $SHELL)rc
    conda install -y -c conda-forge mamba
    mamba update -y -n base -c conda-forge -c anaconda -c bioconda -c defaults conda
    mamba create -y -n vigeas_illumina -c conda-forge -c anaconda -c bioconda -c defaults bwa fastp ivar mafft samtools seqkit
    mamba create -y -n vigeas_sars2 -c conda-forge -c anaconda -c bioconda -c defaults nextclade pangolin
    mamba create -y -n vigeas_summary -c conda-forge -c anaconda -c bioconda -c defaults exonerate ghostscript numpy pandas pysam samtools seaborn seqtk
elif [[ -z $(which mamba) ]]; then
    conda install -y -c conda-forge mamba
    mamba update -y -n base -c conda-forge -c anaconda -c bioconda -c defaults conda
    if [[ -z $(conda env list | grep vigeas_illumina) ]]; then
        mamba create -y -n vigeas_illumina -c conda-forge -c anaconda -c bioconda -c defaults bwa fastp ivar mafft samtools seqkit
    fi
    if [[ -z $(conda env list | grep vigeas_sars2) ]]; then
        mamba create -y -n vigeas_sars2 -c conda-forge -c anaconda -c bioconda -c defaults nextclade pangolin
    fi
    if [[ -z $(conda env list | grep vigeas_summary) ]]; then
        mamba create -y -n vigeas_summary -c conda-forge -c anaconda -c bioconda -c defaults exonerate ghostscript numpy pandas pysam samtools seaborn seqtk
    fi
    source $HOME/.$(basename $SHELL)rc
    conda --version && mamba --version | sed '2d' && echo "" && echo "conda environments:" && conda env list | egrep 'vigeas'
elif [[ ! -z $(which mamba) ]]; then
    if [[ -z $(conda env list | grep vigeas_illumina) ]]; then
        mamba create -y -n vigeas_illumina -c conda-forge -c anaconda -c bioconda -c defaults bwa fastp ivar mafft samtools seqkit
    fi
    if [[ -z $(conda env list | grep vigeas_sars2) ]]; then
        mamba create -y -n vigeas_sars2 -c conda-forge -c anaconda -c bioconda -c defaults nextclade pangolin
    fi
    if [[ -z $(conda env list | grep vigeas_summary) ]]; then
        mamba create -y -n vigeas_summary -c conda-forge -c anaconda -c bioconda -c defaults exonerate ghostscript numpy pandas pysam samtools seaborn seqtk
    fi
    source $HOME/.$(basename $SHELL)rc
    conda --version && mamba --version | sed '2d' && echo "" && echo "conda environments:" && conda env list | egrep 'vigeas'
else
    source $HOME/.$(basename $SHELL)rc
    conda --version && mamba --version | sed '2d' && echo "" && echo "conda environments:" && conda env list | egrep 'vigeas'
fi

if [[ -z $(which fastcov.py) ]]; then
    cd
    wget https://github.com/RaverJay/fastcov/archive/refs/tags/0.1.3.tar.gz
    tar -xvf 0.1.3.tar.gz
    rm -rf 0.1.3.tar.gz
    cd fastcov-0.1.3
    if [[ -z $(cat $HOME/.$(basename $SHELL)rc | grep fastcov-0.1.3) ]]; then
        echo 'export PATH=$HOME/fastcov-0.1.3:/usr/local/share/rsi/idl/bin:$PATH' >> $HOME/.$(basename $SHELL)rc
    fi
    echo "" && echo "RaverJay/fastcov v.0.1.3"
else
    echo "" && echo "RaverJay/fastcov v.0.1.3"
fi
